main:
  params: [event]
  steps:
    - init:
        assign:
          - project_id: ${sys.get_env("sterndeck-4")}
          - latest_message: ""
          - base64: ${base64.decode(event.data.message.data)}
          - message: ${json.decode(base64)}
    - access_secret:
        call: googleapis.secretmanager.v1.projects.secrets.versions.accessString
        args:
          secret_id: ${message.userUid}
          project_id: ${project_id}
        result: str_secret
    - waitandsee:
        steps:
          - get_events:
              call: http.get
              args:
                url: ${"https://api.openai.com/v1/fine-tunes/" + message.fineTuneId + "/events"}
                headers:
                  Authorization: ${"Bearer " + str_secret  }
              result: response
          - init_variables:
              assign:
                - latest_message: ${response.body.data[len(response.body.data) - 1].message}
          - write_to_firestore:
              call: http.post
              args:
                url: https://http-fine-tunes-update-i5rcwtaovq-uc.a.run.app
                headers:
                  Content-Type: "application/json"
                body:
                  user_uid: ${message.userUid}
                  finetuneid: ${message.fineTuneId}
                  collection: ${"models/" + message.userUid + "/list/" + message.modelId + "/training_files/" + message.trainingFileId + "/fine_tunes"}
                auth:
                  type: OIDC
              result: the_result
    - switch_and_repeat:
        switch:
          - condition: ${latest_message == "Fine-tune succeeded"}
            steps:
              - finishit:
                  call: http.post
                  args:
                    url: https://http-fine-tunes-update-i5rcwtaovq-uc.a.run.app
                    headers:
                      Content-Type: "application/json"
                    body:
                      user_uid: ${message.userUid}
                      finetuneid: ${message.fineTuneId}
                      collection: ${"models/" + message.userUid + "/list/" + message.modelId + "/training_files/" + message.trainingFileId + "/fine_tunes"}
                    auth:
                      type: OIDC
                  result: the_result
              - fin:
                  return: '${"finetuneid: " + message.fineTuneId + " latestmessage: " +  latest_message }'
          - condition: ${latest_message == "Fine-tune cancelled"}
            steps:
              - exit:
                  return: '${"finetuneid: " + message.fineTuneId + " latestmessage: " +  latest_message }'
    - wait:
        call: sys.sleep
        args:
          seconds: 60
        next: waitandsee
